# Block access to test files
<FilesMatch "^(test_|create_test_).*\.php$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Add security headers
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

<IfModule mod_rewrite.c>
    <IfModule mod_negotiation.c>
        Options -MultiViews -Indexes
    </IfModule>

    RewriteEngine On

    # Handle Authorization Header
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Handle X-XSRF-Token Header
    RewriteCond %{HTTP:x-xsrf-token} .
    RewriteRule .* - [E=HTTP_X_XSRF_TOKEN:%{HTTP:X-XSRF-Token}]

    # Special handling for SSL payment callbacks to bypass CSRF protection
    # Match all SSL payment callback URLs and direct them to our special handler
    RewriteCond %{QUERY_STRING} (^|&)tran_id= [NC,OR]
    RewriteCond %{QUERY_STRING} (^|&)status=(VALID|SUCCESS|FAILED|CANCELLED) [NC]
    RewriteCond %{REQUEST_URI} ^/(customer/payment/ssl/(success|fail|cancel)|success|fail|cancel|ssl-callback) [NC]
    RewriteRule ^ ssl_callback.php [L,QSA]
    
    # Also catch POST requests to these endpoints
    RewriteCond %{REQUEST_METHOD} POST
    RewriteCond %{REQUEST_URI} ^/(customer/payment/ssl/(success|fail|cancel)|success|fail|cancel|ssl-callback) [NC]
    RewriteRule ^ ssl_callback.php [L,QSA]
    
    # Redirect payment success page requests to our direct payment success page
    RewriteCond %{REQUEST_URI} ^/payment/success [NC]
    RewriteRule ^ payment_success.php [L,QSA]

    # Redirect Trailing Slashes If Not A Folder...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]

    # Send Requests To Front Controller...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php [L]
</IfModule>
